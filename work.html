<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Work</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container work-page">
    <header class="header">
      <h1 class="title">WORK</h1>
      <button class="nav-toggle" id="nav-toggle" aria-label="Toggle navigation"></button>
      <nav class="app-nav" aria-label="App navigation">
      <a href="index.html">Planner</a>
      <a href="habit-builder.html">Habits</a>
      <a href="expense-tracker.html">Expenses</a>
      <a href="pomodoro.html">Pomodoro</a>
      <a href="work.html" class="active">Work</a>
      <button type="button" id="theme-toggle" class="theme-toggle-btn" aria-label="Toggle dark/light mode">
        <span class="theme-icon">üåô</span>
        <span class="theme-text">Dark Mode</span>
      </button>
    </nav>
    </header>
    <section class="calendar-section">
      <div class="calendar-top">
        <div class="date-controls">
          <div class="date-input-row">
            <label for="date-picker" class="sr-only">Select date</label>
            <input type="date" id="date-picker" class="date-picker" aria-label="Select date">
          </div>
        </div>
      </div>

      <div class="calendar-bottom">
        <div class="weekday-toggles" role="group" aria-label="Weekday selection">
          <button type="button" class="weekday-btn" data-day="1">M</button>
          <button type="button" class="weekday-btn" data-day="2">T</button>
          <button type="button" class="weekday-btn" data-day="3">W</button>
          <button type="button" class="weekday-btn" data-day="4">T</button>
          <button type="button" class="weekday-btn" data-day="5">F</button>
          <button type="button" class="weekday-btn" data-day="6">S</button>
          <button type="button" class="weekday-btn" data-day="0">S</button>
        </div>
      </div>
    </section>
    <script>
      (function(){
        const header = document.querySelector('.header');
        const btn = document.getElementById('nav-toggle');
        const nav = document.querySelector('.app-nav');
        const root = document.documentElement;
        if(!btn || !header) return;
        btn.setAttribute('aria-expanded','false');
        btn.addEventListener('click', ()=>{
          const openLocal = header.classList.toggle('nav-open');
          const openGlobal = root.classList.toggle('nav-open');
          btn.setAttribute('aria-expanded', String(openLocal || openGlobal));
        });
        nav && nav.addEventListener('click', (e)=>{ if(e.target.tagName==='A'){ header.classList.remove('nav-open'); root.classList.remove('nav-open'); btn.setAttribute('aria-expanded','false'); } });
        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ header.classList.remove('nav-open'); root.classList.remove('nav-open'); btn.setAttribute('aria-expanded','false'); } });
      })();
    </script>

    <main class="main-content">
      <section class="section">
        <h2 class="section-title">Tasks</h2>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <input id="work-task-input" placeholder="New task" style="flex:1;min-width:200px;padding:10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)">
          <input type="date" id="due-date-input" style="padding:10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text);min-width:140px;">
          <button id="add-work-task" class="add-btn">+</button>
        </div>
        <ul id="work-tasks" style="list-style:none;margin-top:12px;padding:0;display:flex;flex-direction:column;gap:8px"></ul>
        
        <!-- Immediate Due Tasks Section -->
        <div style="margin-top:24px;">
          <h3 style="color:var(--accent);margin-bottom:12px;font-size:1.1rem;">Due Soon (Past, Today, Tomorrow)</h3>
          <ul id="immediate-due-tasks" style="list-style:none;padding:0;display:flex;flex-direction:column;gap:8px"></ul>
        </div>
        
        <!-- Future Due Tasks Section -->
        <div style="margin-top:24px;">
          <h3 style="color:var(--accent);margin-bottom:12px;font-size:1.1rem;">Future Due Tasks</h3>
          <ul id="future-due-tasks" style="list-style:none;padding:0;display:flex;flex-direction:column;gap:8px"></ul>
        </div>
      </section>
    </main>
  </div>

  <script>
    const TASK_KEY = 'dailyplanner:worktasks';
    function load(){ try{return JSON.parse(localStorage.getItem(TASK_KEY))||[] }catch(e){return[]}}
    function save(a){ localStorage.setItem(TASK_KEY, JSON.stringify(a)); }
    const ul = document.getElementById('work-tasks'); const input = document.getElementById('work-task-input');

    function render(){ 
      const arr=load(); 
      ul.innerHTML=''; 
      
      // Only show tasks without due dates in the main list
      arr.forEach((t,i)=>{ 
        if (t.dueDate) return; // Skip tasks with due dates
        
        const li=document.createElement('li'); 
        li.className = 'todo-item';
        li.style.display='flex'; 
        li.style.justifyContent='space-between'; 
        li.style.alignItems='center'; 
        const isCompleted = t.completed || false;
        const textStyle = isCompleted ? 'text-decoration:line-through;color:var(--success);' : '';
        li.innerHTML=`<div style="display:flex;align-items:center;gap:8px;"><input type="checkbox" data-complete="${i}" style="width:16px;height:16px;" ${isCompleted ? 'checked' : ''}><span class="task-text" style="${textStyle}">${convertUrlsToLinks(t.text)}</span></div><div><button data-del="${i}" class="todo-delete" title="Delete task">üóëÔ∏è</button></div>`; 
        ul.appendChild(li); 
      }); 
      
      // Note: renderDueSections() is called separately to avoid conflicts
    }
    
    function renderDueSections() {
      // Use local timezone for date calculations
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      
      const todayStr = formatDate(today);
      const tomorrowStr = formatDate(tomorrow);
      
      // Get all tasks with due dates
      const allTasks = load();
      
      // Separate tasks into immediate and future
      const immediateTasks = [];
      const futureTasks = [];
      
      allTasks.forEach((task, index) => {
        if (!task.dueDate) return; // Skip tasks without due dates
        
        const dueDate = new Date(task.dueDate);
        const dueDateStr = formatDate(dueDate);
        
        // Categorize tasks
        if (dueDateStr <= tomorrowStr) {
          // Past, today, or tomorrow
          immediateTasks.push({...task, originalIndex: index});
        } else {
          // Future tasks (beyond tomorrow)
          futureTasks.push({...task, originalIndex: index});
        }
      });
      
      // Sort immediate tasks by due date (past due first, then today, then tomorrow)
      immediateTasks.sort((a, b) => {
        const dateA = new Date(a.dueDate);
        const dateB = new Date(b.dueDate);
        return dateA - dateB;
      });
      
      // Sort future tasks by due date
      futureTasks.sort((a, b) => {
        const dateA = new Date(a.dueDate);
        const dateB = new Date(b.dueDate);
        return dateA - dateB;
      });
      
      // Render immediate due tasks
      const immediateUl = document.getElementById('immediate-due-tasks');
      immediateUl.innerHTML = '';
      immediateTasks.forEach((task, i) => {
        const li = document.createElement('li');
        li.className = 'todo-item';
        li.style.display = 'flex';
        li.style.justifyContent = 'space-between';
        li.style.alignItems = 'center';
        li.style.padding = '8px';
        li.style.border = '1px solid var(--border)';
        li.style.borderRadius = '8px';
        li.style.backgroundColor = 'var(--surface)';
        
        // Add visual indicator for immediate tasks (using local timezone)
        const taskDueDate = new Date(task.dueDate + 'T00:00:00'); // Ensure local timezone
        const isPastDue = taskDueDate < today;
        const isToday = task.dueDate === todayStr;
        const isTomorrow = task.dueDate === tomorrowStr;
        
        let statusText = '';
        if (isPastDue) {
          statusText = 'Past Due';
          li.style.borderLeft = '4px solid var(--error)';
        } else if (isToday) {
          statusText = 'Due Today';
          li.style.borderLeft = '4px solid var(--warning)';
        } else if (isTomorrow) {
          statusText = 'Due Tomorrow';
          li.style.borderLeft = '4px solid var(--accent)';
        }
        
        const isCompleted = task.completed || false;
        const textStyle = isCompleted ? 'text-decoration:line-through;color:var(--success);' : '';
        const statusStyle = isCompleted ? 'text-decoration:line-through;color:var(--success);' : 'font-size:12px;color:var(--muted)';
        li.innerHTML = `<div style="display:flex;align-items:center;gap:8px;"><input type="checkbox" data-complete="${task.originalIndex}" style="width:16px;height:16px;" ${isCompleted ? 'checked' : ''}><div><strong class="task-text" style="${textStyle}">${convertUrlsToLinks(task.text)}</strong><div style="${statusStyle}">${statusText} - ${task.dueDate}</div></div></div><div><button data-del="${task.originalIndex}" class="todo-delete" title="Delete task">üóëÔ∏è</button></div>`;
        immediateUl.appendChild(li);
      });
      
      // Render future due tasks
      const futureUl = document.getElementById('future-due-tasks');
      futureUl.innerHTML = '';
      futureTasks.forEach((task, i) => {
        const li = document.createElement('li');
        li.className = 'todo-item';
        li.style.display = 'flex';
        li.style.justifyContent = 'space-between';
        li.style.alignItems = 'center';
        li.style.padding = '8px';
        li.style.border = '1px solid var(--border)';
        li.style.borderRadius = '8px';
        li.style.backgroundColor = 'var(--surface)';
        li.style.borderLeft = '4px solid var(--muted)';
        
        const isCompleted = task.completed || false;
        const textStyle = isCompleted ? 'text-decoration:line-through;color:var(--success);' : '';
        const statusStyle = isCompleted ? 'text-decoration:line-through;color:var(--success);' : 'font-size:12px;color:var(--muted)';
        li.innerHTML = `<div style="display:flex;align-items:center;gap:8px;"><input type="checkbox" data-complete="${task.originalIndex}" style="width:16px;height:16px;" ${isCompleted ? 'checked' : ''}><div><strong class="task-text" style="${textStyle}">${convertUrlsToLinks(task.text)}</strong><div style="${statusStyle}">Due: ${task.dueDate}</div></div></div><div><button data-del="${task.originalIndex}" class="todo-delete" title="Delete task">üóëÔ∏è</button></div>`;
        futureUl.appendChild(li);
      });
    }

    function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
    
    // Function to convert URLs to clickable links
    function convertUrlsToLinks(text) {
      if (!text) return '';
      
      // URL regex pattern - matches http/https URLs and common domain patterns
      const urlRegex = /(https?:\/\/[^\s]+|(?:www\.)?[a-zA-Z0-9-]+\.[a-zA-Z]{2,}(?:\/[^\s]*)?)/gi;
      
      return text.replace(urlRegex, (url) => {
        // Ensure URL has protocol
        let href = url;
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
          href = 'https://' + url;
        }
        
        // Escape the URL for HTML
        const escapedUrl = escapeHtml(url);
        const escapedHref = escapeHtml(href);
        
        return `<a href="${escapedHref}" target="_blank" rel="noopener noreferrer nofollow" style="color: var(--accent); text-decoration: underline;">${escapedUrl}</a>`;
      });
    }

    // Function to add a new task
    function addNewTask() {
      const t=input.value.trim(); 
      if(!t) return; 
      const dueDateInput = document.getElementById('due-date-input');
      const dueDate = dueDateInput.value;
      
      const arr=load(); 
      arr.push({text:t, seconds:0, dueDate: dueDate || ''}); 
      save(arr); 
      input.value=''; 
      // Reset date picker to today's date instead of clearing it
      dueDateInput.value = formatDate(new Date());
      render(); 
      renderDueSections();
    }

    // Add click event for the add button
    document.getElementById('add-work-task').addEventListener('click', addNewTask);

    // Add keyboard shortcuts for the task input
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        if (e.shiftKey) {
          // Shift+Enter: Allow default behavior (new line)
          return;
        } else {
          // Enter: Add the task
          e.preventDefault();
          addNewTask();
        }
      }
    });
    // Event delegation for main tasks list
    ul.addEventListener('click',(e)=>{ 
      const idx = e.target.dataset.del || e.target.dataset.complete; 
      if(idx==null) return; 
      const i=Number(idx); 
      const arr=load(); 
      
      if(e.target.dataset.del!=null){ 
        arr.splice(i,1); 
        save(arr); 
        render(); 
        renderDueSections();
        return; 
      } 
      
      if(e.target.dataset.complete!=null && e.target.type === 'checkbox'){ 
        arr[i].completed = e.target.checked;
        save(arr); 
        render(); 
        renderDueSections();
      }
    });

    render();

    // Format date to YYYY-MM-DD string using local timezone
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Set default date to today
    const dueDateInput = document.getElementById('due-date-input');
    if (dueDateInput) {
      dueDateInput.value = formatDate(new Date());
    }

    // Render due sections immediately
    renderDueSections();


    // Date picker and weekday functionality
    (function() {
      const datePicker = document.getElementById('date-picker');
      const weekdayBtns = document.querySelectorAll('.weekday-btn');
      let currentDate = new Date();

      // Get weekday number (0 = Sunday, 1 = Monday, etc.)
      function getWeekday(date) {
        return date.getDay();
      }

      // Update weekday buttons to show current day
      function updateWeekdayButtons() {
        const currentWeekday = getWeekday(currentDate);
        
        weekdayBtns.forEach(btn => {
          const day = parseInt(btn.dataset.day);
          btn.classList.toggle('active', day === currentWeekday);
        });
      }

      // Go to specific weekday (improved logic)
      function goToWeekday(targetDay) {
        const currentWeekday = getWeekday(currentDate);
        const diff = targetDay - currentWeekday;
        
        // Create a new date object to avoid mutation issues
        const newDate = new Date(currentDate);
        newDate.setDate(newDate.getDate() + diff);
        currentDate = newDate;
        
        if (datePicker) {
          datePicker.value = formatDate(currentDate);
        }
        updateWeekdayButtons();
      }

      // Initialize with correct local date
      if (datePicker) {
        // Ensure we're using local date, not UTC
        const localDate = new Date();
        currentDate = new Date(localDate.getFullYear(), localDate.getMonth(), localDate.getDate());
        datePicker.value = formatDate(currentDate);
        updateWeekdayButtons();
        
        // Date picker change event
        datePicker.addEventListener('change', (e) => {
          const selectedDate = new Date(e.target.value);
          if (!isNaN(selectedDate.getTime())) {
            currentDate = selectedDate;
            updateWeekdayButtons();
          }
        });
      }

      // Weekday button events
      weekdayBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const day = parseInt(e.target.dataset.day);
          if (!isNaN(day)) {
            goToWeekday(day);
          }
        });
      });
    })();

    // Add global event listeners for all sections
    document.addEventListener('click', (e) => {
      // Handle checkbox clicks for all sections
      if (e.target.dataset.complete && e.target.type === 'checkbox') {
        const idx = Number(e.target.dataset.complete);
        const arr = load();
        if (arr[idx]) {
          arr[idx].completed = e.target.checked;
          save(arr);
          render();
          renderDueSections();
        }
      }
      
      // Handle delete button clicks for all sections
      if (e.target.dataset.del) {
        const idx = Number(e.target.dataset.del);
        const arr = load();
        if (arr[idx]) {
          arr.splice(idx, 1);
          save(arr);
          render();
          renderDueSections();
        }
      }
    });

    // Due sections are already rendered above
  </script>
</body>
</html>
