<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Work</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Responsive layout for duties and tasks sections */
    .duties-tasks-container {
      display: flex;
      gap: 24px;
      margin-bottom: 24px;
    }
    
    .duties-section, .tasks-section {
      flex: 1;
      min-width: 0; /* Prevents flex items from overflowing */
    }
    
    /* Mobile and small screens - stack vertically */
    @media (max-width: 768px) {
      .duties-tasks-container {
        flex-direction: column;
        gap: 16px;
      }
    }
    
    /* Medium screens and up - side by side */
    @media (min-width: 769px) {
      .duties-tasks-container {
        flex-direction: row;
      }
    }
    
    /* Editable due date styling */
    .due-date-editable {
      transition: color 0.2s ease;
    }
    
    .due-date-editable:hover {
      color: var(--accent) !important;
    }
  </style>
</head>
<body>
    <div class="container work-page">
    <header class="header">
      <!-- Mobile User Profile Icon - Left side next to hamburger -->
      <div class="mobile-user-profile-icon">
          <div id="mobile-user-email" class="mobile-user-email"></div>
      </div>
      
      <!-- User Info Menu - Slides from left -->
      <div id="user-info-menu" class="user-info-menu" style="display: none;">
          <div class="user-info-menu-header">
              <h3>Account Information</h3>
              <button type="button" id="user-info-close-btn" class="user-info-close-btn" aria-label="Close user info">√ó</button>
          </div>
          <div class="user-info-menu-content">
              <div class="info-row">
                  <label>Email:</label>
                  <span id="menu-email">Loading...</span>
              </div>
              <div class="info-row">
                  <label>User Name:</label>
                  <input type="text" id="menu-display-name" class="menu-input" placeholder="Enter name">
              </div>
              <div class="info-row">
                  <label>Account Created:</label>
                  <span id="menu-created">Loading...</span>
              </div>
          </div>
          <div class="user-info-menu-actions">
              <button type="button" id="menu-save-btn" class="menu-save-btn">Save Changes</button>
              <button type="button" id="menu-logout-btn" class="menu-logout-btn">Log Out</button>
              <button type="button" id="menu-delete-btn" class="menu-delete-btn">Delete Account</button>
          </div>
      </div>
      
      <!-- User Info Menu Backdrop -->
      <div id="user-info-menu-backdrop" class="user-info-menu-backdrop"></div>
      
      <h1 class="title">WORK</h1>
      <button class="nav-toggle" id="nav-toggle" aria-label="Toggle navigation"></button>
            <nav class="app-nav" aria-label="App navigation">
                <a href="index.html">Planner</a>
                <a href="habit-builder.html">Habits</a>
                <a href="expense-tracker.html">Expenses</a>
                <a href="pomodoro.html">Pomodoro</a>
                <a href="work.html" class="active">Work</a>
      <div class="nav-controls">
        <button type="button" id="theme-toggle" class="theme-toggle-btn" aria-label="Toggle dark/light mode">
          <span class="theme-icon">üåô</span>
          <span class="theme-text">Dark Mode</span>
        </button>
        <div class="auth-section">
          <div id="auth-status" class="auth-status">
            <span id="user-email" class="user-email"></span>
            <button type="button" id="sign-out-btn" class="sign-out-btn" style="display: none;">Sign Out</button>
            
            <!-- User Info Dropdown -->
            <div id="user-info-dropdown" class="user-info-dropdown" style="display: none;">
                <div class="user-info-header">
                    <h3>Account Information</h3>
                </div>
        <div class="user-info-content">
          <div class="info-row">
            <label>Email:</label>
            <span id="dropdown-email">Loading...</span>
          </div>
          <div class="info-row">
            <label>User Name:</label>
            <input type="text" id="dropdown-display-name" class="dropdown-input" placeholder="Enter name">
          </div>
          <div class="info-row">
            <label>Account Created:</label>
            <span id="dropdown-created">Loading...</span>
          </div>
        </div>
                <div class="user-info-actions">
                    <button type="button" id="save-user-info-btn" class="save-user-info-btn">Save Changes</button>
                    <button type="button" id="dropdown-logout-btn" class="dropdown-logout-btn">Log Out</button>
                    <button type="button" id="delete-account-btn" class="delete-account-btn">Delete Account</button>
                </div>
            </div>
          </div>
          <button type="button" id="sign-in-btn" class="sign-in-btn" style="display: none;">Sign In</button>
        </div>
      </div>
    </nav>
    </header>
    <section class="calendar-section">
      <div class="calendar-top">
        <div class="date-controls">
          <div class="date-input-row">
            <label for="date-picker" class="sr-only">Select date</label>
            <input type="date" id="date-picker" class="date-picker" aria-label="Select date">
          </div>
        </div>
      </div>

      <div class="calendar-bottom">
        <div class="weekday-toggles" role="group" aria-label="Weekday selection">
          <button type="button" class="weekday-btn" data-day="1">M</button>
          <button type="button" class="weekday-btn" data-day="2">T</button>
          <button type="button" class="weekday-btn" data-day="3">W</button>
          <button type="button" class="weekday-btn" data-day="4">T</button>
          <button type="button" class="weekday-btn" data-day="5">F</button>
          <button type="button" class="weekday-btn" data-day="6">S</button>
          <button type="button" class="weekday-btn" data-day="0">S</button>
        </div>
      </div>
    </section>
    <script>
      (function(){
        const header = document.querySelector('.header');
        const btn = document.getElementById('nav-toggle');
        const nav = document.querySelector('.app-nav');
        const root = document.documentElement;
        if(!btn || !header) return;
        btn.setAttribute('aria-expanded','false');
        btn.addEventListener('click', ()=>{
          const openLocal = header.classList.toggle('nav-open');
          const openGlobal = root.classList.toggle('nav-open');
          btn.setAttribute('aria-expanded', String(openLocal || openGlobal));
        });
        nav && nav.addEventListener('click', (e)=>{ if(e.target.tagName==='A'){ header.classList.remove('nav-open'); root.classList.remove('nav-open'); btn.setAttribute('aria-expanded','false'); } });
        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ header.classList.remove('nav-open'); root.classList.remove('nav-open'); btn.setAttribute('aria-expanded','false'); } });
      })();
    </script>

    <main class="main-content">
      <div class="duties-tasks-container">
        <section class="section duties-section">
          <h2 class="section-title">Daily Duties</h2>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <input id="daily-duty-input" placeholder="New daily duty" style="flex:1;min-width:200px;padding:10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)">
            <button id="add-daily-duty" class="add-btn">+</button>
          </div>
          <ul id="daily-duties" style="list-style:none;margin-top:12px;padding:0;display:flex;flex-direction:column;gap:8px"></ul>
        </section>
        
        <section class="section tasks-section">
          <h2 class="section-title">Tasks</h2>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <input id="work-task-input" placeholder="New task" style="flex:1;min-width:200px;padding:10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)">
          <input type="date" id="due-date-input" style="padding:10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text);min-width:140px;">
          <button id="add-work-task" class="add-btn">+</button>
        </div>
        <ul id="work-tasks" style="list-style:none;margin-top:12px;padding:0;display:flex;flex-direction:column;gap:8px"></ul>
        
        <!-- Immediate Due Tasks Section -->
        <div style="margin-top:24px;">
          <h3 style="color:var(--accent);margin-bottom:12px;font-size:1.1rem;">Due Soon (Past, Today, Tomorrow)</h3>
          <ul id="immediate-due-tasks" style="list-style:none;padding:0;display:flex;flex-direction:column;gap:8px"></ul>
        </div>
        
        <!-- Future Due Tasks Section -->
        <div style="margin-top:24px;">
          <h3 style="color:var(--accent);margin-bottom:12px;font-size:1.1rem;">Future Due Tasks</h3>
          <ul id="future-due-tasks" style="list-style:none;padding:0;display:flex;flex-direction:column;gap:8px"></ul>
        </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Authentication Modal -->
  <div id="auth-modal" class="auth-modal" style="display: none;">
    <div class="auth-modal-content">
      <div class="auth-modal-header">
        <button type="button" class="auth-modal-close" aria-label="Close modal">&times;</button>
        <h3>Sign In</h3>
      </div>
      <div class="auth-tabs">
        <button type="button" class="auth-tab active" data-tab="signin">Sign In</button>
        <button type="button" class="auth-tab" data-tab="signup">Sign Up</button>
      </div>
      
      <!-- Sign In Form -->
      <form id="signin-form" class="auth-form">
        <div class="form-group">
          <label for="signin-email">Email</label>
          <input type="email" id="signin-email" placeholder="Enter your email" required>
        </div>
        <div class="form-group">
          <label for="signin-password">Password</label>
          <input type="password" id="signin-password" placeholder="Enter your password" required>
        </div>
        <button type="submit" class="auth-submit-btn">Sign In</button>
        <div id="signin-error" class="auth-error" style="display: none;"></div>
      </form>

      <!-- Sign Up Form -->
      <form id="signup-form" class="auth-form" style="display: none;">
        <div class="form-group">
          <label for="signup-email">Email</label>
          <input type="email" id="signup-email" placeholder="Enter your email" required>
        </div>
        <div class="form-group">
          <label for="signup-password">Password</label>
          <input type="password" id="signup-password" placeholder="Create a password (min 6 characters)" required minlength="6">
        </div>
        <div class="form-group">
          <label for="signup-confirm">Confirm Password</label>
          <input type="password" id="signup-confirm" placeholder="Confirm your password" required>
        </div>
        <button type="submit" class="auth-submit-btn">Sign Up</button>
        <div id="signup-error" class="auth-error" style="display: none;"></div>
      </form>

      <div class="auth-divider">
        <span>or</span>
      </div>
      
      <button type="button" id="google-signin-btn" class="google-signin-btn">
        <svg width="18" height="18" viewBox="0 0 18 18">
          <path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 002.38-5.88c0-.57-.05-.66-.15-1.18z"/>
          <path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2.04a4.8 4.8 0 01-7.18-2.53H1.83v2.07A8 8 0 008.98 17z"/>
          <path fill="#FBBC05" d="M4.5 10.49a4.8 4.8 0 010-3.02V5.4H1.83a8 8 0 000 7.17l2.67-2.08z"/>
          <path fill="#EA4335" d="M8.98 4.72c1.16 0 2.19.4 3.01 1.2l2.26-2.26A7.6 7.6 0 008.98 1a8 8 0 00-7.15 4.4l2.67 2.07c.64-1.94 2.4-3.75 4.48-3.75z"/>
        </svg>
        Continue with Google
      </button>
    </div>
  </div>

  <script>
    const TASK_KEY = 'dailyplanner:worktasks';
    const DAILY_DUTIES_KEY = 'dailyplanner:dailyduties';
    
    function load(){ try{return JSON.parse(localStorage.getItem(TASK_KEY))||[] }catch(e){return[]}}
    function save(a){ localStorage.setItem(TASK_KEY, JSON.stringify(a)); }
    
    function loadDailyDuties(){ try{return JSON.parse(localStorage.getItem(DAILY_DUTIES_KEY))||[] }catch(e){return[]}}
    function saveDailyDuties(a){ localStorage.setItem(DAILY_DUTIES_KEY, JSON.stringify(a)); }
    
    const ul = document.getElementById('work-tasks'); const input = document.getElementById('work-task-input');
    const dailyDutiesUl = document.getElementById('daily-duties'); const dailyDutyInput = document.getElementById('daily-duty-input');

    function renderDailyDuties(){ 
      const arr=loadDailyDuties(); 
      dailyDutiesUl.innerHTML=''; 
      
      arr.forEach((t,i)=>{ 
        const li=document.createElement('li'); 
        li.className = 'todo-item';
        li.style.display='flex'; 
        li.style.justifyContent='space-between'; 
        li.style.alignItems='center'; 
        const isCompleted = t.completed || false;
        const textStyle = isCompleted ? 'text-decoration:line-through;color:var(--success);' : '';
        li.innerHTML=`<div style="display:flex;align-items:center;gap:8px;"><input type="checkbox" data-complete-duty="${i}" style="width:16px;height:16px;" ${isCompleted ? 'checked' : ''}><span class="duty-text" style="${textStyle}">${convertUrlsToLinks(t.text)}</span></div><div><button data-del-duty="${i}" class="todo-delete" title="Delete duty">üóëÔ∏è</button></div>`; 
        dailyDutiesUl.appendChild(li); 
      }); 
    }

    function render(){ 
      const arr=load(); 
      ul.innerHTML=''; 
      
      // Only show tasks without due dates in the main list
      arr.forEach((t,i)=>{ 
        if (t.dueDate) return; // Skip tasks with due dates
        
        const li=document.createElement('li'); 
        li.className = 'todo-item';
        li.style.display='flex'; 
        li.style.justifyContent='space-between'; 
        li.style.alignItems='center'; 
        const isCompleted = t.completed || false;
        const textStyle = isCompleted ? 'text-decoration:line-through;color:var(--success);' : '';
        li.innerHTML=`<div style="display:flex;align-items:center;gap:8px;"><input type="checkbox" data-complete="${i}" style="width:16px;height:16px;" ${isCompleted ? 'checked' : ''}><span class="task-text" style="${textStyle}">${convertUrlsToLinks(t.text)}</span></div><div><button data-del="${i}" class="todo-delete" title="Delete task">üóëÔ∏è</button></div>`; 
        ul.appendChild(li); 
      }); 
      
      // Note: renderDueSections() is called separately to avoid conflicts
    }
    
    function renderDueSections() {
      // Use local timezone for date calculations
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      
      const todayStr = formatDate(today);
      const tomorrowStr = formatDate(tomorrow);
      
      // Get all tasks with due dates
      const allTasks = load();
      
      // Separate tasks into immediate and future
      const immediateTasks = [];
      const futureTasks = [];
      
      allTasks.forEach((task, index) => {
        if (!task.dueDate) return; // Skip tasks without due dates
        
        const dueDate = new Date(task.dueDate);
        const dueDateStr = formatDate(dueDate);
        
        // Categorize tasks
        if (dueDateStr <= tomorrowStr) {
          // Past, today, or tomorrow
          immediateTasks.push({...task, originalIndex: index});
        } else {
          // Future tasks (beyond tomorrow)
          futureTasks.push({...task, originalIndex: index});
        }
      });
      
      // Sort immediate tasks by due date (past due first, then today, then tomorrow)
      immediateTasks.sort((a, b) => {
        const dateA = new Date(a.dueDate);
        const dateB = new Date(b.dueDate);
        return dateA - dateB;
      });
      
      // Sort future tasks by due date
      futureTasks.sort((a, b) => {
        const dateA = new Date(a.dueDate);
        const dateB = new Date(b.dueDate);
        return dateA - dateB;
      });
      
      // Render immediate due tasks
      const immediateUl = document.getElementById('immediate-due-tasks');
      immediateUl.innerHTML = '';
      immediateTasks.forEach((task, i) => {
        const li = document.createElement('li');
        li.className = 'todo-item';
        li.style.display = 'flex';
        li.style.justifyContent = 'space-between';
        li.style.alignItems = 'center';
        li.style.padding = '8px';
        li.style.border = '1px solid var(--border)';
        li.style.borderRadius = '8px';
        li.style.backgroundColor = 'var(--surface)';
        
        // Add visual indicator for immediate tasks (using local timezone)
        const taskDueDate = new Date(task.dueDate + 'T00:00:00'); // Ensure local timezone
        const isPastDue = taskDueDate < today;
        const isToday = task.dueDate === todayStr;
        const isTomorrow = task.dueDate === tomorrowStr;
        
        let statusText = '';
        if (isPastDue) {
          statusText = 'Past Due';
          li.style.borderLeft = '4px solid var(--error)';
        } else if (isToday) {
          statusText = 'Due Today';
          li.style.borderLeft = '4px solid var(--warning)';
        } else if (isTomorrow) {
          statusText = 'Due Tomorrow';
          li.style.borderLeft = '4px solid var(--accent)';
        }
        
        const isCompleted = task.completed || false;
        const textStyle = isCompleted ? 'text-decoration:line-through;color:var(--success);' : '';
        const statusStyle = isCompleted ? 'text-decoration:line-through;color:var(--success);' : 'font-size:12px;color:var(--muted)';
        li.innerHTML = `<div style="display:flex;align-items:center;gap:8px;"><input type="checkbox" data-complete="${task.originalIndex}" style="width:16px;height:16px;" ${isCompleted ? 'checked' : ''}><div><strong class="task-text" style="${textStyle}">${convertUrlsToLinks(task.text)}</strong><div style="${statusStyle}"><span class="status-text">${statusText} - </span><span class="due-date-editable" data-edit-date="${task.originalIndex}" style="cursor:pointer;text-decoration:underline;">${task.dueDate}</span></div></div></div><div><button data-del="${task.originalIndex}" class="todo-delete" title="Delete task">üóëÔ∏è</button></div>`;
        immediateUl.appendChild(li);
      });
      
      // Render future due tasks
      const futureUl = document.getElementById('future-due-tasks');
      futureUl.innerHTML = '';
      futureTasks.forEach((task, i) => {
        const li = document.createElement('li');
        li.className = 'todo-item';
        li.style.display = 'flex';
        li.style.justifyContent = 'space-between';
        li.style.alignItems = 'center';
        li.style.padding = '8px';
        li.style.border = '1px solid var(--border)';
        li.style.borderRadius = '8px';
        li.style.backgroundColor = 'var(--surface)';
        li.style.borderLeft = '4px solid var(--muted)';
        
        const isCompleted = task.completed || false;
        const textStyle = isCompleted ? 'text-decoration:line-through;color:var(--success);' : '';
        const statusStyle = isCompleted ? 'text-decoration:line-through;color:var(--success);' : 'font-size:12px;color:var(--muted)';
        li.innerHTML = `<div style="display:flex;align-items:center;gap:8px;"><input type="checkbox" data-complete="${task.originalIndex}" style="width:16px;height:16px;" ${isCompleted ? 'checked' : ''}><div><strong class="task-text" style="${textStyle}">${convertUrlsToLinks(task.text)}</strong><div style="${statusStyle}">Due: <span class="due-date-editable" data-edit-date="${task.originalIndex}" style="cursor:pointer;text-decoration:underline;">${task.dueDate}</span></div></div></div><div><button data-del="${task.originalIndex}" class="todo-delete" title="Delete task">üóëÔ∏è</button></div>`;
        futureUl.appendChild(li);
      });
    }

    function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
    
    // Function to convert URLs to clickable links
    function convertUrlsToLinks(text) {
      if (!text) return '';
      
      // URL regex pattern - matches http/https URLs and common domain patterns
      const urlRegex = /(https?:\/\/[^\s]+|(?:www\.)?[a-zA-Z0-9-]+\.[a-zA-Z]{2,}(?:\/[^\s]*)?)/gi;
      
      return text.replace(urlRegex, (url) => {
        // Ensure URL has protocol
        let href = url;
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
          href = 'https://' + url;
        }
        
        // Escape the URL for HTML
        const escapedUrl = escapeHtml(url);
        const escapedHref = escapeHtml(href);
        
        return `<a href="${escapedHref}" target="_blank" rel="noopener noreferrer nofollow" style="color: var(--accent); text-decoration: underline;">${escapedUrl}</a>`;
      });
    }

    // Function to add a new task
    function addNewTask() {
      const t=input.value.trim(); 
      if(!t) return; 
      const dueDateInput = document.getElementById('due-date-input');
      const dueDate = dueDateInput.value;
      
      const arr=load(); 
      arr.push({text:t, seconds:0, dueDate: dueDate || ''}); 
      save(arr); 
      input.value=''; 
      // Reset date picker to today's date instead of clearing it
      dueDateInput.value = formatDate(new Date());
      render(); 
      renderDueSections();
    }

    // Function to add a new daily duty
    function addNewDailyDuty() {
      const t = dailyDutyInput.value.trim(); 
      if(!t) return; 
      
      const arr = loadDailyDuties(); 
      arr.push({text:t, completed: false}); 
      saveDailyDuties(arr); 
      dailyDutyInput.value=''; 
      renderDailyDuties();
    }

    // Add click event for the add button
    document.getElementById('add-work-task').addEventListener('click', addNewTask);
    document.getElementById('add-daily-duty').addEventListener('click', addNewDailyDuty);

    // Add keyboard shortcuts for the task input
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        if (e.shiftKey) {
          // Shift+Enter: Allow default behavior (new line)
          return;
        } else {
          // Enter: Add the task
          e.preventDefault();
          addNewTask();
        }
      }
    });

    // Add keyboard shortcuts for the daily duty input
    dailyDutyInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        if (e.shiftKey) {
          // Shift+Enter: Allow default behavior (new line)
          return;
        } else {
          // Enter: Add the duty
          e.preventDefault();
          addNewDailyDuty();
        }
      }
    });
    // Event delegation for main tasks list
    ul.addEventListener('click',(e)=>{ 
      const idx = e.target.dataset.del || e.target.dataset.complete; 
      if(idx==null) return; 
      const i=Number(idx); 
      const arr=load(); 
      
      if(e.target.dataset.del!=null){ 
        arr.splice(i,1); 
        save(arr); 
        render(); 
        renderDueSections();
        return; 
      } 
      
      if(e.target.dataset.complete!=null && e.target.type === 'checkbox'){ 
        arr[i].completed = e.target.checked;
        save(arr); 
        render(); 
        renderDueSections();
      }
    });

    render();
    renderDailyDuties();

    // Format date to YYYY-MM-DD string using local timezone
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Set default date to today
    const dueDateInput = document.getElementById('due-date-input');
    if (dueDateInput) {
      dueDateInput.value = formatDate(new Date());
    }

    // Render due sections immediately
    renderDueSections();


    // Date picker and weekday functionality
    (function() {
      const datePicker = document.getElementById('date-picker');
      const weekdayBtns = document.querySelectorAll('.weekday-btn');
      let currentDate = new Date();

      // Get weekday number (0 = Sunday, 1 = Monday, etc.)
      function getWeekday(date) {
        return date.getDay();
      }

      // Update weekday buttons to show current day
      function updateWeekdayButtons() {
        const currentWeekday = getWeekday(currentDate);
        
        weekdayBtns.forEach(btn => {
          const day = parseInt(btn.dataset.day);
          btn.classList.toggle('active', day === currentWeekday);
        });
      }

      // Go to specific weekday (improved logic)
      function goToWeekday(targetDay) {
        const currentWeekday = getWeekday(currentDate);
        const diff = targetDay - currentWeekday;
        
        // Create a new date object to avoid mutation issues
        const newDate = new Date(currentDate);
        newDate.setDate(newDate.getDate() + diff);
        currentDate = newDate;
        
        if (datePicker) {
          datePicker.value = formatDate(currentDate);
        }
        updateWeekdayButtons();
      }

      // Initialize with correct local date
      if (datePicker) {
        // Ensure we're using local date, not UTC
        const localDate = new Date();
        currentDate = new Date(localDate.getFullYear(), localDate.getMonth(), localDate.getDate());
        datePicker.value = formatDate(currentDate);
        updateWeekdayButtons();
        
        // Date picker change event
        datePicker.addEventListener('change', (e) => {
          const selectedDate = new Date(e.target.value);
          if (!isNaN(selectedDate.getTime())) {
            currentDate = selectedDate;
            updateWeekdayButtons();
          }
        });
      }

      // Weekday button events
      weekdayBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const day = parseInt(e.target.dataset.day);
          if (!isNaN(day)) {
            goToWeekday(day);
          }
        });
      });
    })();

    // Add global event listeners for all sections
    document.addEventListener('click', (e) => {
      // Handle checkbox clicks for tasks
      if (e.target.dataset.complete && e.target.type === 'checkbox') {
        const idx = Number(e.target.dataset.complete);
        const arr = load();
        if (arr[idx]) {
          arr[idx].completed = e.target.checked;
          save(arr);
          render();
          renderDueSections();
        }
      }
      
      // Handle checkbox clicks for daily duties
      if (e.target.dataset.completeDuty && e.target.type === 'checkbox') {
        const idx = Number(e.target.dataset.completeDuty);
        const arr = loadDailyDuties();
        if (arr[idx]) {
          arr[idx].completed = e.target.checked;
          saveDailyDuties(arr);
          renderDailyDuties();
        }
      }
      
      // Handle delete button clicks for tasks
      if (e.target.dataset.del) {
        const idx = Number(e.target.dataset.del);
        const arr = load();
        if (arr[idx]) {
          arr.splice(idx, 1);
          save(arr);
          render();
          renderDueSections();
        }
      }
      
      // Handle delete button clicks for daily duties
      if (e.target.dataset.delDuty) {
        const idx = Number(e.target.dataset.delDuty);
        const arr = loadDailyDuties();
        if (arr[idx]) {
          arr.splice(idx, 1);
          saveDailyDuties(arr);
          renderDailyDuties();
        }
      }
      
      // Handle due date editing
      if (e.target.classList.contains('due-date-editable')) {
        const idx = Number(e.target.dataset.editDate);
        const arr = load();
        if (arr[idx]) {
          // Create a temporary date input
          const dateInput = document.createElement('input');
          dateInput.type = 'date';
          dateInput.value = arr[idx].dueDate;
          dateInput.style.cssText = 'padding:4px;border-radius:4px;border:1px solid var(--accent);background:var(--surface);color:var(--text);font-size:12px;';
          
          // Replace the text with the date input
          const originalText = e.target.textContent;
          e.target.innerHTML = '';
          e.target.appendChild(dateInput);
          e.target.style.cursor = 'default';
          
          // Focus and select the input
          dateInput.focus();
          dateInput.select();
          
          // Handle saving the new date
          const saveDate = () => {
            const newDate = dateInput.value;
            if (newDate && newDate !== arr[idx].dueDate) {
              arr[idx].dueDate = newDate;
              save(arr);
              render();
              renderDueSections();
            } else {
              // Restore original text if no change
              e.target.innerHTML = originalText;
              e.target.style.cursor = 'pointer';
            }
          };
          
          // Save on change or blur
          dateInput.addEventListener('change', saveDate);
          dateInput.addEventListener('blur', saveDate);
          
          // Save on Enter key
          dateInput.addEventListener('keydown', (keyEvent) => {
            if (keyEvent.key === 'Enter') {
              saveDate();
            } else if (keyEvent.key === 'Escape') {
              // Cancel editing
              e.target.innerHTML = originalText;
              e.target.style.cursor = 'pointer';
            }
          });
        }
      }
    });

    // Due sections are already rendered above
  </script>

  <!-- Firebase SDK -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { 
      getAuth, 
      signInWithEmailAndPassword, 
      createUserWithEmailAndPassword, 
      signInWithPopup, 
      GoogleAuthProvider, 
      signOut, 
      onAuthStateChanged,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    
    // Initialize Firebase
    async function initializeFirebase() {
      // Try to load Firebase config from separate file
      let firebaseConfig;
      try {
        const configModule = await import('./firebase-config.js');
        firebaseConfig = configModule.firebaseConfig;
        console.log('‚úÖ Loaded Firebase config from file');
      } catch (error) {
        console.warn('‚ö†Ô∏è No Firebase config file found, using localStorage only');
        return;
      }

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();

    // Make Firebase available globally
    window.firebase = { app, db, auth, googleProvider, updateProfile };
    
    // Authentication state change handler
    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log('User signed in:', user.uid, user.email);
        updateAuthUI(user);
      } else {
        console.log('No user signed in');
        updateAuthUI(null);
      }
    });

    // Authentication UI management
    function updateAuthUI(user) {
      console.log('updateAuthUI called with user:', user);
      const signInBtn = document.getElementById('sign-in-btn');
      const signOutBtn = document.getElementById('sign-out-btn');
      const userEmail = document.getElementById('user-email');
      const mobileUserEmail = document.getElementById('mobile-user-email');
      const authModal = document.getElementById('auth-modal');
      const userInfoDropdown = document.getElementById('user-info-dropdown');
      const userInfoMenu = document.getElementById('user-info-menu');

      console.log('Auth elements found:', { signInBtn, signOutBtn, userEmail, mobileUserEmail, authModal });

      if (user) {
        // User is signed in
        console.log('User is signed in, updating UI...');
        if (signInBtn) signInBtn.style.display = 'none';
        if (signOutBtn) signOutBtn.style.display = 'none'; // Hide sign out button
        if (userEmail) {
          // Show person icon instead of name
          userEmail.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>';
          userEmail.style.display = 'block';
        }
        if (mobileUserEmail) {
          // Show person icon in mobile nav
          mobileUserEmail.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>';
          mobileUserEmail.style.display = 'block';
        }
        if (authModal) authModal.style.display = 'none';
        
        // Hide account info sections initially (they'll be shown when user clicks the person icon)
        if (userInfoDropdown) userInfoDropdown.style.display = 'none';
        if (userInfoMenu) userInfoMenu.style.display = 'none';
        
        // Restore account info content for signed in users
        restoreAccountInfoForSignedInUser();
      } else {
        // User is not signed in
        console.log('User is not signed in, showing sign in button...');
        if (signInBtn) signInBtn.style.display = 'block';
        if (signOutBtn) signOutBtn.style.display = 'none';
        if (userEmail) {
          userEmail.textContent = '';
          userEmail.style.display = 'none';
        }
        if (mobileUserEmail) {
          // Always show mobile user profile icon on mobile devices, even when not signed in
          mobileUserEmail.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>';
          mobileUserEmail.style.display = 'block';
        }
        
        // Hide account info sections when user is not signed in
        if (userInfoDropdown) userInfoDropdown.style.display = 'none';
        if (userInfoMenu) userInfoMenu.style.display = 'none';
        
        // Show sign-in/sign-up content in account info section
        updateAccountInfoForSignedOutUser();
      }
    }

    // Restore account info content for signed in users
    function restoreAccountInfoForSignedInUser() {
      const userInfoDropdown = document.getElementById('user-info-dropdown');
      const userInfoMenu = document.getElementById('user-info-menu');
      
      if (userInfoDropdown) {
        // Restore the original account info content
        const header = userInfoDropdown.querySelector('.user-info-header h3');
        const content = userInfoDropdown.querySelector('.user-info-content');
        const actions = userInfoDropdown.querySelector('.user-info-actions');
        
        if (header) header.textContent = 'Account Information';
        if (content) {
          content.innerHTML = `
            <div class="info-row">
              <label>Email:</label>
              <span id="dropdown-email">Loading...</span>
            </div>
            <div class="info-row">
              <label>User Name:</label>
              <input type="text" id="dropdown-display-name" class="dropdown-input" placeholder="Enter name">
            </div>
            <div class="info-row">
              <label>Account Created:</label>
              <span id="dropdown-created">Loading...</span>
            </div>
          `;
        }
        if (actions) actions.style.display = 'block';
      }
      
      if (userInfoMenu) {
        // Same for mobile menu
        const header = userInfoMenu.querySelector('.user-info-menu-header h3');
        const content = userInfoMenu.querySelector('.user-info-menu-content');
        const actions = userInfoMenu.querySelector('.user-info-menu-actions');
        
        if (header) header.textContent = 'Account Information';
        if (content) {
          content.innerHTML = `
            <div class="info-row">
              <label>Email:</label>
              <span id="menu-email">Loading...</span>
            </div>
            <div class="info-row">
              <label>User Name:</label>
              <input type="text" id="menu-display-name" class="menu-input" placeholder="Enter name">
            </div>
            <div class="info-row">
              <label>Account Created:</label>
              <span id="menu-created">Loading...</span>
            </div>
          `;
        }
        if (actions) actions.style.display = 'block';
      }
    }

    // Update account info section for signed out users
    function updateAccountInfoForSignedOutUser() {
      const userInfoDropdown = document.getElementById('user-info-dropdown');
      const userInfoMenu = document.getElementById('user-info-menu');
      
      if (userInfoDropdown) {
        // Replace the account info content with sign-in/sign-up options
        const header = userInfoDropdown.querySelector('.user-info-header h3');
        const content = userInfoDropdown.querySelector('.user-info-content');
        const actions = userInfoDropdown.querySelector('.user-info-actions');
        
        if (header) header.textContent = 'Sign In / Sign Up';
        if (content) {
          content.innerHTML = `
            <div class="auth-options">
              <p>Please sign in to access your account information and sync your data across devices.</p>
              <div class="auth-buttons">
                <button type="button" id="dropdown-signin-btn" class="dropdown-signin-btn">Sign In</button>
                <button type="button" id="dropdown-signup-btn" class="dropdown-signup-btn">Sign Up</button>
              </div>
            </div>
          `;
        }
        if (actions) actions.style.display = 'none';
      }
      
      if (userInfoMenu) {
        // Same for mobile menu
        const header = userInfoMenu.querySelector('.user-info-menu-header h3');
        const content = userInfoMenu.querySelector('.user-info-menu-content');
        const actions = userInfoMenu.querySelector('.user-info-menu-actions');
        
        if (header) header.textContent = 'Sign In / Sign Up';
        if (content) {
          content.innerHTML = `
            <div class="auth-options">
              <p>Please sign in to access your account information and sync your data across devices.</p>
              <div class="auth-buttons">
                <button type="button" id="menu-signin-btn" class="menu-signin-btn">Sign In</button>
                <button type="button" id="menu-signup-btn" class="menu-signup-btn">Sign Up</button>
              </div>
            </div>
          `;
        }
        if (actions) actions.style.display = 'none';
      }
      
      // Add event listeners for the new buttons
      addAuthButtonListeners();
    }
    
    // Function to close mobile menu
    function closeMobileMenu() {
      const header = document.querySelector('.header');
      const root = document.documentElement;
      const toggle = document.getElementById('nav-toggle');
      
      if (header) header.classList.remove('nav-open');
      if (root) root.classList.remove('nav-open');
      if (toggle) toggle.setAttribute('aria-expanded', 'false');
    }
    
    // Make closeMobileMenu available globally
    window.closeMobileMenu = closeMobileMenu;
    
    // Add event listeners for auth buttons in account info sections
    let authButtonListenersAdded = false;
    function addAuthButtonListeners() {
      // Only add listeners once to avoid duplicates
      if (authButtonListenersAdded) return;
      authButtonListenersAdded = true;
      
      // Use event delegation to handle dynamically created buttons
      document.addEventListener('click', (e) => {
        // Handle desktop dropdown buttons
        if (e.target && e.target.id === 'dropdown-signin-btn') {
          e.preventDefault();
          switchAuthTab('signin');
          showAuthModal();
        }
        
        if (e.target && e.target.id === 'dropdown-signup-btn') {
          e.preventDefault();
          switchAuthTab('signup');
          showAuthModal();
        }
        
        // Handle mobile menu buttons (close menu when clicked)
        if (e.target && e.target.id === 'menu-signin-btn') {
          e.preventDefault();
          closeMobileMenu(); // Close mobile menu first
          switchAuthTab('signin');
          showAuthModal();
        }
        
        if (e.target && e.target.id === 'menu-signup-btn') {
          e.preventDefault();
          closeMobileMenu(); // Close mobile menu first
          switchAuthTab('signup');
          showAuthModal();
        }
      });
    }

    // Authentication functions
    window.authFunctions = {
      async signIn(email, password) {
        try {
          const userCredential = await signInWithEmailAndPassword(auth, email, password);
          console.log('Signed in:', userCredential.user);
          return userCredential;
        } catch (error) {
          console.error('Sign in error:', error);
          throw error;
        }
      },

      async signUp(email, password) {
        try {
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          console.log('Signed up:', userCredential.user);
          return userCredential;
        } catch (error) {
          console.error('Sign up error:', error);
          throw error;
        }
      },

      async signInWithGoogle() {
        try {
          const result = await signInWithPopup(auth, googleProvider);
          console.log('Google sign in:', result.user);
          return result;
        } catch (error) {
          console.error('Google sign in error:', error);
          throw error;
        }
      },

      async signOut() {
        try {
          await signOut(auth);
          console.log('Signed out');
        } catch (error) {
          console.error('Sign out error:', error);
          throw error;
        }
      }
    };
    }
    
      // Call the initialization function
      initializeFirebase();
      
      // Ensure authentication UI is correct by default (fallback)
      setTimeout(() => {
        const signInBtn = document.getElementById('sign-in-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const userEmail = document.getElementById('user-email');
        const mobileUserEmail = document.getElementById('mobile-user-email');
        
        // Check if user is actually signed in by checking Firebase auth state
        if (auth.currentUser) {
          console.log('Fallback: User is signed in, updating UI...');
          if (signInBtn) signInBtn.style.display = 'none';
          if (signOutBtn) signOutBtn.style.display = 'none';
          if (userEmail) {
            // Show person icon instead of name
            userEmail.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>';
            userEmail.style.display = 'block';
          }
          if (mobileUserEmail) {
            // Show person icon in mobile nav
            mobileUserEmail.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>';
            mobileUserEmail.style.display = 'block';
          }
        } else {
          console.log('Fallback: No user signed in, showing sign-in button');
          if (signInBtn) signInBtn.style.display = 'block';
          if (signOutBtn) signOutBtn.style.display = 'none';
          if (userEmail) userEmail.style.display = 'none';
          if (mobileUserEmail) {
            // Always show mobile user profile icon on mobile devices, even when not signed in
            mobileUserEmail.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>';
            mobileUserEmail.style.display = 'block';
          }
        }
      }, 1000);
  </script>
  
  <script src="script.js"></script>
</body>
</html>
